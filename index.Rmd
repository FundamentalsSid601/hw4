---
title: "Dataframe Restructuring"
author: "Sidhant Sharma"
output:
  html_document:
    df_print: paged
---


### Merging

```{r}
# Read the cleaned infant mortality dataset from CSV (created in HW3)
infant_new <- read.csv("infant_mortality_clean.csv", stringsAsFactors = FALSE)

# Read the cleaned life expectancy dataset from CSV (created in HW3)
life_exp_new <- read.csv("life_expectancy_clean.csv", stringsAsFactors = FALSE)

# Read the cleaned maternal mortality dataset from CSV (created in HW3)
maternal_new <- read.csv("maternal_mortality_clean.csv", stringsAsFactors = FALSE)

# Confirm the structure of each cleaned dataset
str(infant_new); str(life_exp_new); str(maternal_new)
```


```{r}
# Merge infant + life expectancy by country (keep only countries present in both = inner join)
merged_12 <- merge(infant_new, life_exp_new, by = "country", suffixes = c("_imr", "_le"))

# Create a single region column (prefer the infant region if present, else life expectancy region)
merged_12$region <- ifelse(is.na(merged_12$region_imr) | merged_12$region_imr == "", merged_12$region_le, merged_12$region_imr)

# Drop the duplicate region columns to avoid unnecessary variables
merged_12$region_imr <- NULL; merged_12$region_le <- NULL

# Merge with maternal mortality by country (inner join to keep consistent complete cases)
merged_all <- merge(merged_12, maternal_new, by = "country")

# The merge brought in a second region column from maternal_new - it gets auto-named "region.y"
# Our existing region from merged_12 is now "region.x"
# Create a final single region column (prefer the first region unless missing)
merged_all$region <- ifelse(is.na(merged_all$region.x) | merged_all$region.x == "", merged_all$region.y, merged_all$region.x)

# Drop the duplicate region columns
merged_all$region.x <- NULL
merged_all$region.y <- NULL


```

```{r}
# Reorder columns into a clean “wide” merged dataset
merged_all <- merged_all[, c("country", "region", "infant_mortality_per_1000", "life_expectancy_years", "maternal_mortality_per_100k")]

# Preview the merged dataset (human check)
head(merged_all)

# Save merged dataset as CSV so it can be pushed to GitHub
write.csv(merged_all, "cia_merged_wide.csv", row.names = FALSE, na = "")

# Verify the file was created in the working directory (required by rubric)
file.exists("cia_merged_wide.csv")

# Re-open the saved file to verify it saved correctly and types are reasonable
merged_check <- read.csv("cia_merged_wide.csv", stringsAsFactors = FALSE)

# Verify structure after saving (required verification code)
str(merged_check)

# Verify expected columns exist (required verification code)
names(merged_check)
```

### Aggregating

```{r}
# Aggregate the merged data by region using median (robust to outliers in health data)
aggregated <- aggregate(
  cbind(infant_mortality_per_1000, life_expectancy_years, maternal_mortality_per_100k) ~ region,
  data = merged_all,
  FUN = median,
  na.rm = TRUE
)

# Preview the aggregated dataset
aggregated

# Save aggregated dataset as CSV
write.csv(aggregated, "cia_aggregated_by_region.csv", row.names = FALSE)

# Verify the file was created
file.exists("cia_aggregated_by_region.csv")

# Re-read and verify structure
agg_check <- read.csv("cia_aggregated_by_region.csv", stringsAsFactors = FALSE)
str(agg_check)
```

### Reshaping

```{r}
# Reshape wide to long format using reshape() from base R
# Keep country and region as id variables, stack the three metric columns
merged_long <- reshape(
  merged_all,
  direction = "long",
  varying = c("infant_mortality_per_1000", "life_expectancy_years", "maternal_mortality_per_100k"),
  v.names = "value",
  timevar = "metric",
  times = c("infant_mortality_per_1000", "life_expectancy_years", "maternal_mortality_per_100k"),
  idvar = c("country", "region")
)

# Reset row names for cleaner output
rownames(merged_long) <- NULL

# Preview the long format dataset
head(merged_long)

# Save long format dataset as CSV
write.csv(merged_long, "cia_merged_long.csv", row.names = FALSE)

# Verify the file was created
file.exists("cia_merged_long.csv")

# Re-read and verify structure
long_check <- read.csv("cia_merged_long.csv", stringsAsFactors = FALSE)
str(long_check)

# Verify the reshape worked: should have 3x the rows of wide format
nrow(merged_long) == nrow(merged_all) * 3
```
