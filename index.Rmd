---
title: "Dataframe Restructuring"
author: "Sidhant Sharma"
output:
  html_document:
    df_print: paged
---

### Importing Relevant Files

```{r}
# Read the cleaned datasets from CSV (created in HW3)
infant_new <- read.csv("infant_mortality_clean.csv")
life_exp_new <- read.csv("life_expectancy_clean.csv")
maternal_new <- read.csv("maternal_mortality_clean.csv")
```

### Merging

```{r}
# Merge infant + life expectancy by country (inner join)
merged_df <- merge(infant_new, life_exp_new, by = "country", suffixes = c("_imr", "_le"))

# Create a single region column
merged_df$region <- ifelse(is.na(merged_df$region_imr) | merged_df$region_imr == "", merged_df$region_le, merged_df$region_imr)
merged_df$region_imr <- NULL
merged_df$region_le <- NULL

# Merge with maternal mortality by country
merged_all <- merge(merged_df, maternal_new, by = "country")

# Consolidate region columns (region.x and region.y from merge)
merged_all$region <- ifelse(is.na(merged_all$region.x) | merged_all$region.x == "", merged_all$region.y, merged_all$region.x)
merged_all$region.x <- NULL
merged_all$region.y <- NULL

# Reorder columns
merged_all <- merged_all[, c("country", "region", "infant_mortality_per_1000", "life_expectancy_years", "maternal_mortality_per_100k")]

# Save merged dataset as CSV
write.csv(merged_all, "cia_merged_data.csv", row.names = FALSE, na = "")
file.exists("cia_merged_data.csv")

# View result
head(read.csv("cia_merged_data.csv"))
```

### Aggregating

```{r}
library(dplyr)

# Aggregate using mean (average) by region
aggregated <- merged_all %>%
  group_by(region) %>%
  summarise(
    avg_infant_mortality = mean(infant_mortality_per_1000, na.rm = TRUE),
    avg_life_expectancy = mean(life_expectancy_years, na.rm = TRUE),
    avg_maternal_mortality = mean(maternal_mortality_per_100k, na.rm = TRUE)
  )

# Save aggregated dataset as CSV
write.csv(aggregated, "cia_aggregated_by_region.csv", row.names = FALSE)
file.exists("cia_aggregated_by_region.csv")

# View result
head(read.csv("cia_aggregated_by_region.csv"))
```

### Reshaping

```{r}
library(tidyr)

# Convert from wide to long format
long_df <- merged_all[, -which(names(merged_all) == "region")]
long_df <- pivot_longer(
  long_df,
    cols = -country,
    names_to = "variable",
    values_to = "value"
  )

# Save long format file
write.csv(long_df, "cia_merged_long.csv", row.names = FALSE)
file.exists("cia_merged_long.csv")

# View result
head(read.csv("cia_merged_long.csv"))
```
